"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.createParser = void 0;
var nearley_1 = require("nearley");
var grammar_1 = __importDefault(require("./grammar"));
var lexer_1 = __importDefault(require("./lexer"));
var error_with_loc_1 = __importDefault(require("../lib/error-with-loc"));
function createParser(opts) {
    return new nearley_1.Parser(nearley_1.Grammar.fromCompiled(grammar_1.default), opts);
}
exports.createParser = createParser;
/** Entry point for parsing an input string into an AST module. */
function parse(input, opts) {
    var parser = createParser(opts);
    try {
        parser.feed(input);
        // Add terminating line break (necessary due to lack of EOF terminal).
        parser.feed('\n');
    }
    catch (e) {
        if ('token' in e) {
            throw new error_with_loc_1.default(
            // Hack to reduce verbosity of nearley error messages...
            e.message.replace(/ Instead, I was expecting to see one of the following:$[\s\S]*/gm, ''), {
                sourceFileName: opts === null || opts === void 0 ? void 0 : opts.sourceFileName,
                loc: e.token,
            });
        }
        else {
            throw e;
        }
    }
    if (parser.results.length === 0) {
        throw new error_with_loc_1.default("Unexpected end of input", {
            sourceFileName: opts === null || opts === void 0 ? void 0 : opts.sourceFileName,
            loc: lexer_1.default.lastToken,
        });
    }
    else if (parser.results.length !== 1) {
        throw new error_with_loc_1.default("".concat(parser.results.length, " parse trees:\n\n") +
            parser.results
                .map(function (tree, idx) {
                return "Parse tree #".concat(idx + 1, ":\n").concat(JSON.stringify(tree, null, 4));
            })
                .join('\n\n'), {
            sourceFileName: opts === null || opts === void 0 ? void 0 : opts.sourceFileName,
            loc: lexer_1.default.lastToken,
        });
    }
    return parser.results[0];
}
exports.default = parse;
